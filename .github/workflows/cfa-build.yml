name: Build Unsigned IPA

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
        repository: catalinatCore/Clash-For-Apple
        ref: main
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    #- name: Install dependencies
      #run: |
        #brew install cocoapods
        #pod install

    - name: Build the app
      run: |
        xcodebuild -workspace Clash.xcodeproj -scheme clash -sdk iphoneos -configuration Release build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

    - name: Create IPA directory and move the app
      run: |
        mkdir Payload
        cp -R ./build/Release-iphoneos/clash.app ./Payload/clash.app

    - name: Zip the Payload directory to create an IPA
      run: |
        zip -r clash.ipa Payload

    - name: Upload the unsigned IPA
      uses: actions/upload-artifact@v2
      with:
        name: clash-for-apple-ipa
        path: clash.ipa
