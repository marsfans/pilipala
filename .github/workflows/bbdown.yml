name: Multi-Platform bbdown Build (external repo)

on:
  workflow_dispatch:
    inputs:
      repository:
        description: '要 checkout 的仓库，格式 owner/repo，例如 nilaoda/BBDown'
        required: true
        default: 'nilaoda/BBDown'
      ref:
        description: '要构建的 ref（branch/tag/commit），例如 main 或 v1.0.0。若要创建 release，请输入以 v 开头的 tag（例如 v1.2.3）'
        required: true
        default: 'v1.6.3'
      token:
        description: '可选：当目标仓库为私有时填入 PAT 的 Secret 名称（例如 PERSONAL_TOKEN）'
        required: false
        default: ''

jobs:
  build:
    # 并行矩阵：每项会在对应 runner 上并行运行
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
            rid: win-x64
          - os: windows-latest
            runtime: win-arm64
            rid: win-arm64
          - os: ubuntu-latest
            runtime: linux-x64
            rid: linux-x64
          - os: ubuntu-latest
            runtime: linux-arm64
            rid: linux-arm64
          - os: macos-latest
            runtime: osx-x64
            rid: osx-x64
          - os: macos-latest
            runtime: osx-arm64
            rid: osx-arm64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout target repository (full history)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repository }}
          fetch-depth: 0
          # 如果目标 repo 是私有的并且你在触发时传入了 token（例如 PERSONAL_TOKEN）：
          # 取消下面注释并把 token 输入设为 SECRET 名称，然后在触发时填写该 secret 名称
          # token: ${{ secrets[ github.event.inputs.token ] }}

      # -------- 通用：根据需要设置 .NET（若目标不是 dotnet，请替换这些步骤为你的构建步骤） -----------
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Publish for runtime ${{ matrix.rid }}
        run: |
          set -eux
          OUT=./publish/${{ matrix.rid }}
          mkdir -p "$OUT"

          RID="${{ matrix.rid }}"

          if [ "$RID" = "linux-arm64" ]; then
            sudo apt-get update -y
            sudo apt-get install -y wget gnupg ca-certificates lsb-release software-properties-common apt-transport-https || true
            # 导入 LLVM GPG key
            wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/llvm-archive-keyring.gpg
            # 添加 llvm-toolchain-<codename>-9 仓库
            echo "deb [signed-by=/usr/share/keyrings/llvm-archive-keyring.gpg] http://apt.llvm.org/${CODENAME}/ llvm-toolchain-${CODENAME}-9 main" | sudo tee /etc/apt/sources.list.d/llvm-9.list
            sudo apt-get update -y
            sudo apt-get install -y wget build-essential clang-9 lld-9 libicu-dev zlib1g libcurl4-openssl-dev libkrb5-dev
            dotnet publish -c Release -r "$RID" \
              -p:StripSymbols=true \
              -p:CppCompilerAndLinker=clang-9 \
              -p:SysRoot=/crossrootfs/arm64 \
              -o "$OUT"
          else
            dotnet publish -c Release -r "$RID" -o "$OUT"
          fi
        shell: bash

      # -------- 打包 artifact（Windows 使用 7z，Linux/macOS 使用 zip） -----------
      - name: Package artifact
        id: package
        run: |
          set -eux
          OUT=publish/${{ matrix.rid }}
          BASENAME=bbdown-${{ github.event.inputs.ref }}-${{ matrix.rid }}

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows 打包 zip
            ZIPNAME=${BASENAME}.zip
            powershell -Command "Add-Type -AssemblyName 'System.IO.Compression.FileSystem'; [IO.Compression.ZipFile]::CreateFromDirectory('${OUT}', '${ZIPNAME}')"
            echo "artifact=$ZIPNAME" >> "$GITHUB_OUTPUT"
          else
            # Linux/Mac 打包 tar.gz
            TAR=${BASENAME}.tar.gz
            tar -czf "$TAR" -C "$OUT" .
            echo "artifact=$TAR" >> "$GITHUB_OUTPUT"
          fi
        shell: bash


      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bbdown-${{ github.event.inputs.ref }}-${{ matrix.rid }}-${{ matrix.os }}
          path: ${{ steps.package.outputs.artifact }}


  # 当 ref 是以 v 开头的 tag（比如 v1.2.3）时，执行 release 作业。
  # release 作业依赖 build（等所有矩阵完成），然后下载所有 artifacts、创建 release 并附加 zip 文件。
  release:
    if: startsWith(github.event.inputs.ref, 'v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all build artifacts
        # 不指定 name 会把所有 artifact 全部下载到 ./artifacts 目录
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded files (for debug)
        run: |
          echo "files under artifacts:"
          find artifacts -type f -maxdepth 3 -print
        shell: bash

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          # 使用触发输入的 ref 作为 tag 名（例如 v1.2.3）
          tag_name: bbdown_${{ github.event.inputs.ref }}
          # release title，可自定义为同名或带前缀
          name: bbdown ${{ github.event.inputs.ref }}
          # 将 artifacts 目录下所有 zip 上传到 release。glob 支持通配。
          files: artifacts/**/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
