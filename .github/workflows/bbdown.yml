name: Multi-Platform bbdown Build (external repo)

on:
  workflow_dispatch:
    inputs:
      repository:
        description: '要 checkout 的仓库，格式 owner/repo，例如 nilaoda/BBDown'
        required: true
        default: 'nilaoda/BBDown'
      ref:
        description: '要构建的 ref（branch/tag/commit），例如 main 或 v1.0.0'
        required: true
        default: 'main'
      token:
        description: '可选：当目标仓库为私有时填入 PAT 的 Secret 名称（例如 PERSONAL_TOKEN）'
        required: false
        default: ''


jobs:
  build:
    # 并行矩阵：每项会在对应 runner 上并行运行
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
            rid: win-x64
          - os: ubuntu-latest
            runtime: linux-x64
            rid: linux-x64
          - os: ubuntu-latest
            runtime: linux-arm64
            rid: linux-arm64
          - os: macos-latest
            runtime: osx-x64
            rid: osx-x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout target repository (full history)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repository }}
          fetch-depth: 0
          # 如果目标 repo 是私有的并且你在触发时传入了 token（例如 PERSONAL_TOKEN）：
          # 取消下面注释并把 token 输入设为 SECRET 名称，然后在触发时填写该 secret 名称
          # token: ${{ secrets[ github.event.inputs.token ] }}

      
      # -------- 通用：根据需要设置 .NET（若目标不是 dotnet，请替换这些步骤为你的构建步骤） -----------
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Publish for runtime ${{ matrix.rid }}
        run: |
          set -eux
          OUT=./publish/${{ matrix.rid }}
          mkdir -p "$OUT"
          dotnet publish -c Release -r ${{ matrix.rid }} --self-contained false -o "$OUT"
        shell: bash

      # -------- 打包 artifact（Windows 使用 7z，Linux/macOS 使用 zip） -----------
      - name: Package artifact
        id: package
        run: |
          set -eux
          OUT=publish/${{ matrix.rid }}
          ZIPNAME=artifact-${{ github.event.inputs.ref }}-${{ matrix.rid }}.zip

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # windows runner 上通常预装 7z；使用 powershell 打包以兼容路径
            powershell -Command "Add-Type -AssemblyName 'System.IO.Compression.FileSystem'; [IO.Compression.ZipFile]::CreateFromDirectory('${OUT}', '${ZIPNAME}')"
          else
            # ubuntu/macos: 安装 zip（在 runner 已有时 apt-get/install 会自动跳过/失败安全）
            if command -v apt-get >/dev/null 2>&1; then
              sudo apt-get update -y || true
              sudo apt-get install -y zip || true
            fi
            if command -v brew >/dev/null 2>&1; then
              brew install zip || true
            fi
            zip -r "$ZIPNAME" "$OUT"
          fi

          echo "zipname=$ZIPNAME" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.event.inputs.ref }}-${{ matrix.rid }}-${{ matrix.os }}
          path: ${{ steps.package.outputs.zipname }}

      # 如果 ref 是 tag（以 v 开头），可选创建 Release 并附加 artifact（需要 GITHUB_TOKEN）
      - name: Create GitHub Release (if ref is tag v*)
        if: startsWith(github.event.inputs.ref, 'v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
